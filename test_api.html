<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileMaker API Tester</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ FileMaker API Connection Tester</h1>
        
        <div class="test-section">
            <h3>Test Controls</h3>
            <button onclick="runAllTests()">Run All Tests</button>
            <button onclick="testAuth()">Test Auth Only</button>
            <button onclick="testSearch()">Test Search</button>
            <button onclick="testCreate()">Test Create Job</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="test-section">
            <h3>Search Test</h3>
            <input type="text" id="searchOrder" placeholder="Order Number" value="9970070005">
            <button onclick="searchSpecificOrder()">Search Order</button>
        </div>

        <div class="test-section">
            <h3>Test Log</h3>
            <div id="log" class="log">Ready to test...</div>
        </div>
    </div>

    <script>
        const CONFIG = {
            BASE_URL: 'https://modd.mainspringhost.com/fmi/data/vLatest',
            USERNAME: 'trevor_api',
            PASSWORD: 'XcScS2yRoTtMo7',
            SEARCH_DB: 'PEP2_1',
            CREATE_DB: 'pep-move-api',
            SEARCH_LAYOUT: 'jobs_api',
            CREATE_LAYOUT: 'table'
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = 'Ready to test...\n';
        }

        async function authenticate(database) {
            const response = await fetch(`${CONFIG.BASE_URL}/databases/${database}/sessions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Basic ${btoa(`${CONFIG.USERNAME}:${CONFIG.PASSWORD}`)}`
                }
            });

            const data = await response.json();
            
            if (response.ok && data.messages?.[0]?.code === '0') {
                return { success: true, token: data.response.token };
            }
            
            throw new Error(JSON.stringify(data));
        }

        async function logout(database, token) {
            await fetch(`${CONFIG.BASE_URL}/databases/${database}/sessions/${token}`, {
                method: 'DELETE'
            });
        }

        async function testAuth() {
            log('=== Testing Authentication ===', 'info');
            
            // Test Search DB
            try {
                log(`Authenticating to ${CONFIG.SEARCH_DB}...`, 'info');
                const auth = await authenticate(CONFIG.SEARCH_DB);
                log(`âœ“ ${CONFIG.SEARCH_DB} authentication successful`, 'success');
                log(`  Token: ${auth.token.substring(0, 30)}...`, 'info');
                await logout(CONFIG.SEARCH_DB, auth.token);
                log(`âœ“ Logout successful`, 'success');
            } catch (error) {
                log(`âœ— ${CONFIG.SEARCH_DB} authentication failed: ${error.message}`, 'error');
            }

            // Test Create DB
            try {
                log(`Authenticating to ${CONFIG.CREATE_DB}...`, 'info');
                const auth = await authenticate(CONFIG.CREATE_DB);
                log(`âœ“ ${CONFIG.CREATE_DB} authentication successful`, 'success');
                await logout(CONFIG.CREATE_DB, auth.token);
                log(`âœ“ Logout successful`, 'success');
            } catch (error) {
                log(`âœ— ${CONFIG.CREATE_DB} authentication failed: ${error.message}`, 'error');
            }
        }

        async function testSearch() {
            log('=== Testing Job Search ===', 'info');
            
            try {
                const auth = await authenticate(CONFIG.SEARCH_DB);
                log('âœ“ Authenticated', 'success');

                const response = await fetch(
                    `${CONFIG.BASE_URL}/databases/${CONFIG.SEARCH_DB}/layouts/${CONFIG.SEARCH_LAYOUT}/_find`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${auth.token}`
                        },
                        body: JSON.stringify({
                            query: [{ 'client_order_number': '9970070005' }],
                            limit: '5'
                        })
                    }
                );

                const data = await response.json();
                
                if (data.messages?.[0]?.code === '401') {
                    log('âœ“ Search executed (no records found)', 'warning');
                } else if (response.ok && data.response?.data) {
                    log(`âœ“ Search successful - Found ${data.response.data.length} record(s)`, 'success');
                    const job = data.response.data[0]?.fieldData;
                    if (job) {
                        log(`  Job Type: ${job.job_type}`, 'info');
                        log(`  Status: ${job.job_status}`, 'info');
                        log(`  Customer: ${job.Customer_C1}`, 'info');
                    }
                } else {
                    log(`âœ— Search failed: ${response.status}`, 'error');
                    log(`  ${JSON.stringify(data, null, 2)}`, 'error');
                }
                
                await logout(CONFIG.SEARCH_DB, auth.token);
            } catch (error) {
                log(`âœ— Search failed: ${error.message}`, 'error');
            }
        }

        async function searchSpecificOrder() {
            const orderNumber = document.getElementById('searchOrder').value;
            log(`=== Searching for Order #${orderNumber} ===`, 'info');
            
            try {
                const auth = await authenticate(CONFIG.SEARCH_DB);
                
                const response = await fetch(
                    `${CONFIG.BASE_URL}/databases/${CONFIG.SEARCH_DB}/layouts/${CONFIG.SEARCH_LAYOUT}/_find`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${auth.token}`
                        },
                        body: JSON.stringify({
                            query: [{ 'client_order_number': orderNumber }],
                            limit: '10'
                        })
                    }
                );

                const data = await response.json();
                
                if (data.messages?.[0]?.code === '401') {
                    log('âœ“ No records found for this order number', 'warning');
                } else if (response.ok && data.response?.data) {
                    log(`âœ“ Found ${data.response.data.length} record(s)`, 'success');
                    data.response.data.forEach((record, idx) => {
                        const job = record.fieldData;
                        log(`\n  Record ${idx + 1}:`, 'info');
                        log(`    Job ID: ${job._kp_job_id}`, 'info');
                        log(`    Type: ${job.job_type}`, 'info');
                        log(`    Status: ${job.job_status}`, 'info');
                        log(`    Customer: ${job.Customer_C1}`, 'info');
                    });
                } else {
                    log(`âœ— Search failed: ${JSON.stringify(data)}`, 'error');
                }
                
                await logout(CONFIG.SEARCH_DB, auth.token);
            } catch (error) {
                log(`âœ— Search error: ${error.message}`, 'error');
            }
        }

        async function testCreate() {
            log('=== Testing Job Creation ===', 'info');
            
            const testJob = {
                job_status: 'Entered',
                job_type: 'TEST',
                client_order_number: `TEST_${Date.now()}`,
                date_received: new Date().toISOString().split('T')[0],
                product_serial_number: `TEST_SN_${Date.now()}`,
                Customer_C1: 'Test Customer',
                address_C1: '123 Test Street',
                zip_C1: '12345'
            };

            try {
                const auth = await authenticate(CONFIG.CREATE_DB);
                log('âœ“ Authenticated', 'success');

                // Try with payload wrapper
                log('Trying format 1: payload wrapper...', 'info');
                let response = await fetch(
                    `${CONFIG.BASE_URL}/databases/${CONFIG.CREATE_DB}/layouts/${CONFIG.CREATE_LAYOUT}/records`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${auth.token}`
                        },
                        body: JSON.stringify({
                            fieldData: {
                                payload: JSON.stringify(testJob)
                            }
                        })
                    }
                );

                let data = await response.json();
                
                if (response.ok && data.response?.recordId) {
                    log(`âœ“ Job created with payload format!`, 'success');
                    log(`  Record ID: ${data.response.recordId}`, 'success');
                    log(`  Order #: ${testJob.client_order_number}`, 'info');
                } else {
                    log(`âœ— Payload format failed: ${response.status}`, 'warning');
                    log(`  ${JSON.stringify(data, null, 2)}`, 'warning');
                    
                    // Try direct fieldData
                    log('Trying format 2: direct fieldData...', 'info');
                    response = await fetch(
                        `${CONFIG.BASE_URL}/databases/${CONFIG.CREATE_DB}/layouts/${CONFIG.CREATE_LAYOUT}/records`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${auth.token}`
                            },
                            body: JSON.stringify({ fieldData: testJob })
                        }
                    );

                    data = await response.json();
                    
                    if (response.ok && data.response?.recordId) {
                        log(`âœ“ Job created with direct format!`, 'success');
                        log(`  Record ID: ${data.response.recordId}`, 'success');
                        log(`  Order #: ${testJob.client_order_number}`, 'info');
                        log(`  NOTE: Use direct fieldData format`, 'warning');
                    } else {
                        log(`âœ— Both formats failed`, 'error');
                        log(`  ${JSON.stringify(data, null, 2)}`, 'error');
                    }
                }
                
                await logout(CONFIG.CREATE_DB, auth.token);
            } catch (error) {
                log(`âœ— Job creation failed: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            clearLog();
            log('=== Running All Tests ===\n', 'info');
            await testAuth();
            log('\n', 'info');
            await testSearch();
            log('\n', 'info');
            await testCreate();
            log('\n=== All Tests Complete ===', 'info');
        }
    </script>
</body>
</html>
